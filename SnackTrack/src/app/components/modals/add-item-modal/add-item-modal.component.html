<ion-header>
  <ion-toolbar>
    <ion-title>{{
      isEdit ? "Artikel bearbeiten" : "Neuer Artikel"
    }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="dismiss()">
        <ion-icon name="close"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content #content class="ion-padding">
  <!-- Validation Errors Summary -->
  @if(showValidationErrors && !isFormValid()) {
    <ion-card color="danger" class="validation-error-card">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="alert-circle-outline" slot="start"></ion-icon>
          Fehlende Angaben
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          @for (error of getValidationErrors(); track error) {
            <ion-item color="danger" lines="none">
              <ion-icon name="close-circle" slot="start" color="light"></ion-icon>
              <ion-label color="light">{{ error }}</ion-label>
            </ion-item>
          }
        </ion-list>
        <ion-button
          fill="outline"
          color="light"
          size="small"
          (click)="showValidationErrors = false"
          class="close-errors-btn"
        >
          <ion-icon name="close" slot="start"></ion-icon>
          Schließen
        </ion-button>
      </ion-card-content>
    </ion-card>
  }

  <!-- Barcode Scanner Section -->
  <ion-button
    fill="solid"
    color="tertiary"
    (click)="openBarcodeScanner()"
    class="scanner-button">
    <ion-icon name="barcode-outline" slot="start"></ion-icon>
    Barcode scannen
  </ion-button>

  <form #form="ngForm">
    <!-- Barcode Section -->
    <ion-item>
      <ion-label position="stacked">Barcode</ion-label>
      <ion-input
        type="text"
        [(ngModel)]="formData.barcode"
        name="barcode"
        placeholder="Barcode eingeben oder scannen"
        required>
      </ion-input>
      <ion-button
        slot="end"
        fill="clear"
        (click)="searchByBarcode()"
        [disabled]="isLoadingProduct || !formData.barcode.trim()">
        <ion-icon name="search-outline" *ngIf="!isLoadingProduct"></ion-icon>
        <ion-spinner name="crescent" *ngIf="isLoadingProduct"></ion-spinner>
      </ion-button>
    </ion-item>

    <!-- Product Image -->
    <ion-item *ngIf="formData.image_url">
      <ion-thumbnail slot="start">
        <img [src]="formData.image_url" [alt]="formData.name" />
      </ion-thumbnail>
      <ion-label>
        <h2>{{ formData.name }}</h2>
        <p *ngIf="formData.brand">{{ formData.brand }}</p>
      </ion-label>
    </ion-item>

    <ion-item>
      <ion-label position="stacked">Name des Artikels</ion-label>
      <ion-input
        [(ngModel)]="formData.name"
        name="name"
        required
        placeholder="z.B. Milch, Äpfel, Brot..."
      >
      </ion-input>
    </ion-item>

    <ion-item *ngIf="formData.brand || productFound">
      <ion-label position="stacked">Marke</ion-label>
      <ion-input
        [(ngModel)]="formData.brand"
        name="brand"
        placeholder="z.B. Müller, Coca-Cola..."
      >
      </ion-input>
    </ion-item>

    <ion-item>
      <ion-label position="stacked">Menge</ion-label>
      <ion-input
        [(ngModel)]="formData.quantity"
        name="quantity"
        type="number"
        required
        min="0.01"
        step="0.01"
        placeholder="1"
      >
      </ion-input>
    </ion-item>

    <ion-item>
      <ion-label position="stacked">Einheit</ion-label>
      <ion-select
        [(ngModel)]="formData.unit"
        name="unit"
        required
        interface="popover"
      >
        @for (unit of foodUnits; track unit) {
          <ion-select-option [value]="unit">
            {{ getUnitLabel(unit) }}
          </ion-select-option>
        }
      </ion-select>
    </ion-item>

    <ion-item>
      <ion-label position="stacked">Lagerort</ion-label>
      <ion-select
        [(ngModel)]="formData.storageLocationId"
        name="storageLocationId"
        required
        interface="popover"
        placeholder="Lagerort auswählen"
      >
         @for (location of storageLocations; track location.location_id) {
           <ion-select-option [value]="location.location_id">
            {{ location.name }}
          </ion-select-option>
        }
      </ion-select>
    </ion-item>

    <ion-item>
      <ion-label position="stacked">Ablaufdatum</ion-label>
      <ion-grid>
        <ion-row class="ion-justify-content-center">
          <ion-col size="auto">

            @if (isPickerReady) {
              <ion-datetime
                [(ngModel)]="formData.expiryDate"
                name="expiryDate"
                required
                presentation="date"
                [min]="minDate"
                [max]="maxDate">
              </ion-datetime>
            } @else {
              <div style="padding: 20px 0;">
                <ion-spinner name="crescent"></ion-spinner>
              </div>
            }

          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-item>

    <ion-item>
      <ion-label position="stacked">Notizen (optional)</ion-label>
      <ion-textarea
        [(ngModel)]="formData.notes"
        name="notes"
        placeholder="z.B. geöffnet am..."
        rows="2"
      >
      </ion-textarea>
    </ion-item>

    <!-- Preview -->
    @if(formData.name && formData.storageLocationId) {
      <div class="preview-section">
        <ion-label class="preview-label">Vorschau:</ion-label>
        <ion-item class="preview-item">
          <ion-label>
            <h3>{{ formData.name }}</h3>
            <p>{{ formData.quantity }} {{ getUnitLabel(formData.unit) }}</p>
            <p>{{ getStorageLocationName() }}</p>
            <p>Läuft ab: {{ formatExpiryDate() }}</p>
          </ion-label>
        </ion-item>
      </div>
    }
  </form>
</ion-content>

<ion-footer>
  <ion-toolbar>
    <ion-button
      expand="block"
      (click)="save()"
      [color]="isFormValid() ? 'primary' : 'medium'"
      class="ion-margin"
    >
      {{ isEdit ? "Aktualisieren" : "Hinzufügen" }}
    </ion-button>
  </ion-toolbar>
</ion-footer>
